
/*! @file UrbanPopAgentStruct.H
    \brief Contains #UrbanPopAgent class used for reading in UrbanPop data
    File automatically generated by UrbanPop-scripts/extract_urbanpop_feather.py
*/

#pragma once

#include <stdlib.h>
#include <string.h>
#include <fstream>
#include <sstream>

using std::string;
using float32_t = amrex::Real;

namespace UrbanPop {

const size_t NUM_COLS = 17;

const int ROLE_COUNT = 3;
static string role_descriptions[ROLE_COUNT] = {"nope", "worker", "student"};
struct ROLE { enum {nope, worker, student}; };
const int NAICS_COUNT = 21;
static string naics_descriptions[NAICS_COUNT] = {"agr_ffh", "ext", "utl", "con", "mfg", "whl", "ret", "trn_whs", "inf", "fin_ins", "rrl", "prf", "mgt", "adm_wmr", "edu", "med_sca", "ent", "afs", "srv", "pad", "wfh"};
struct NAICS { enum {agr_ffh, ext, utl, con, mfg, whl, ret, trn_whs, inf, fin_ins, rrl, prf, mgt, adm_wmr, edu, med_sca, ent, afs, srv, pad, wfh}; };
const int GRADE_COUNT = 31;
static string grade_descriptions[GRADE_COUNT] = {"childcare", "k12pub_preschl", "k12pub_kind", "k12pub_1st", "k12pub_2nd", "k12pub_3rd", "k12pub_4th", "k12pub_5th", "k12pub_6th", "k12pub_7th", "k12pub_8th", "k12pub_9th", "k12pub_10th", "k12pub_11th", "k12pub_12th", "k12pv_preschl", "k12pv_kind", "k12pv_1st", "k12pv_2nd", "k12pv_3rd", "k12pv_4th", "k12pv_5th", "k12pv_6th", "k12pv_7th", "k12pv_8th", "k12pv_9th", "k12pv_10th", "k12pv_11th", "k12pv_12th", "undergrad", "grad"};
struct GRADE { enum {childcare, k12pub_preschl, k12pub_kind, k12pub_1st, k12pub_2nd, k12pub_3rd, k12pub_4th, k12pub_5th, k12pub_6th, k12pub_7th, k12pub_8th, k12pub_9th, k12pub_10th, k12pub_11th, k12pub_12th, k12pv_preschl, k12pv_kind, k12pv_1st, k12pv_2nd, k12pv_3rd, k12pv_4th, k12pv_5th, k12pv_6th, k12pv_7th, k12pv_8th, k12pv_9th, k12pv_10th, k12pv_11th, k12pv_12th, undergrad, grad}; };


static std::vector<string> split_string(const string &s, char delim) {
    std::vector<string> elems;
    std::stringstream ss(s);
    string item;
    while (std::getline(ss, item, delim)) elems.push_back(item);
    return elems;
}

struct UrbanPopAgent {
    int64_t id;
    int32_t household_id;
    int64_t home_geoid;
    float32_t home_lat;
    float32_t home_lng;
    int64_t work_geoid;
    float32_t work_lat;
    float32_t work_lng;
    int8_t age;
    int8_t sex;
    int8_t race;
    int8_t travel;
    int8_t veh_occ;
    int8_t role;
    int8_t naics;
    int8_t grade;
    int16_t school_id;

    bool read_csv(std::ifstream &f) {
        string buf;
        if (!getline(f, buf)) return false;
        if (buf[0] != '*') {
            id = -1;
            return true;
        }
        try {
            std::vector<string> tokens = split_string(buf.substr(2), ',');
            if (tokens.size() != NUM_COLS)
                throw std::runtime_error("Incorrect number of tokens, expected " + std::to_string(NUM_COLS) +
                                         " got " + std::to_string(tokens.size()));
            id = stol(tokens[0]);
            household_id = stoi(tokens[1]);
            home_geoid = stol(tokens[2]);
            home_lat = stof(tokens[3]);
            home_lng = stof(tokens[4]);
            work_geoid = stol(tokens[5]);
            work_lat = stof(tokens[6]);
            work_lng = stof(tokens[7]);
            age = stoi(tokens[8]);
            sex = stoi(tokens[9]);
            race = stoi(tokens[10]);
            travel = stoi(tokens[11]);
            veh_occ = stoi(tokens[12]);
            role = stoi(tokens[13]);
            naics = stoi(tokens[14]);
            grade = stoi(tokens[15]);
            school_id = stoi(tokens[16]);

        } catch (const std::exception &ex) {
            std::ostringstream os;
            os << "Error reading UrbanPop input file: " << ex.what() << ", line read: " << "'" << buf << "'";
            amrex::Abort(os.str());
        }
        return true;
    }

    friend std::ostream& operator<<(std::ostream& os, const UrbanPopAgent& agent) {
        os << std::fixed << std::setprecision(6);
        os << agent.id << ",";
        os << agent.household_id << ",";
        os << agent.home_geoid << ",";
        os << agent.home_lat << ",";
        os << agent.home_lng << ",";
        os << agent.work_geoid << ",";
        os << agent.work_lat << ",";
        os << agent.work_lng << ",";
        os << (int)agent.age << ",";
        os << (int)agent.sex << ",";
        os << (int)agent.race << ",";
        os << (int)agent.travel << ",";
        os << (int)agent.veh_occ << ",";
        os << (int)agent.role << (agent.role != -1 ? ":" + role_descriptions[agent.role] : "") << ",";
        os << (int)agent.naics << (agent.naics != -1 ? ":" + naics_descriptions[agent.naics] : "") << ",";
        os << (int)agent.grade << (agent.grade != -1 ? ":" + grade_descriptions[agent.grade] : "") << ",";
        os << agent.school_id;
        return os;
    }
};
} // namespace UrbanPop

